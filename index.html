<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Presupuestador R谩pido</title>
    
    <!-- PWA: Color de tema para la barra de estado (Android/iOS) -->
    <meta name="theme-color" content="#008069">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Presupuestos">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos (Phosphor Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-transition { transition: background-color 0.2s, border-color 0.2s, transform 0.1s; }
        .ease-spring { transition-timing-function: cubic-bezier(0.05, 0.7, 0.1, 1.0); }
        #toast {
            visibility: hidden; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show {
            visibility: visible; opacity: 1; bottom: 100px;
        }
        /* Puntos de paginaci贸n del tutorial */
        .dot { transition: all 0.3s; }
        .dot.active { background-color: #008069; transform: scale(1.2); }
        
        /* Estilos para el Toggle de Variantes */
        .variant-pill {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            text-transform: uppercase;
            font-weight: 700;
            white-space: nowrap;
        }
        .variant-pill.active {
            background-color: #e6fcf5; /* green-50 */
            color: #008069;
            border-color: #008069;
        }
        .variant-pill.inactive {
            background-color: #f3f4f6; /* gray-100 */
            color: #6b7280; /* gray-500 */
            border-color: #e5e7eb;
        }
    </style>

    <!-- SCRIPT PWA: Generaci贸n din谩mica del Manifiesto e Iconos -->
    <script>
        (function() {
            // 1. Icono Base64 (SVG minimalista verde)
            const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" fill="#008069"/><path d="M386 166c-13-13-33-16-56-11l-35 8c-63 15-119 71-134 134l-8 35c-5 23-2 43 11 56 16 16 43 16 71-11l9-8c4-4 10-4 14 0l46 46c4 4 4 10 0 14l-8 9c-27 28-27 55-11 71 21 21 68 12 101-20l46-46c33-33 42-80 21-101-16-16-43-16-71 11l-9 8c-4 4-10 4-14 0l-46-46c-4-4-4-10 0-14l8-9c27-28 27-55 11-71z" fill="white" opacity="0.3"/><path d="M256 64C150 64 64 150 64 256s86 192 192 192 192-86 192-192S362 64 256 64zm0 336c-79.5 0-144-64.5-144-144S176.5 112 256 112s144 64.5 144 144-64.5 144-144 144zm-16-224h-32v96h-64v32h64v64h32v-64h64v-32h-64v-96z" fill="white"/></svg>`;
            const iconUrl = "data:image/svg+xml;base64," + btoa(iconSvg);

            // 2. Inyectar Favicon
            const linkIcon = document.createElement('link');
            linkIcon.rel = 'icon';
            linkIcon.href = iconUrl;
            document.head.appendChild(linkIcon);

            // 3. Inyectar Apple Touch Icon
            const linkApple = document.createElement('link');
            linkApple.rel = 'apple-touch-icon';
            linkApple.href = iconUrl;
            document.head.appendChild(linkApple);

            // 4. Construir y Linkear Manifiesto ROBUSTO para Android
            const manifest = {
                "id": "/presupuestador-app-v2.6", // ID actualizado
                "name": "Presupuestador R谩pido",
                "short_name": "Presupuestos",
                "start_url": "./index.html",
                "display": "standalone",
                "background_color": "#ffffff",
                "theme_color": "#008069",
                "orientation": "portrait",
                "scope": ".",
                "icons": [
                    {
                        "src": iconUrl,
                        "sizes": "192x192",
                        "type": "image/svg+xml",
                        "purpose": "any"
                    }, 
                    {
                        "src": iconUrl,
                        "sizes": "512x512",
                        "type": "image/svg+xml",
                        "purpose": "maskable"
                    }
                ]
            };
            const manifestUrl = "data:application/manifest+json;base64," + btoa(JSON.stringify(manifest));
            const linkManifest = document.createElement('link');
            linkManifest.rel = 'manifest';
            linkManifest.href = manifestUrl;
            document.head.appendChild(linkManifest);
        })();
    </script>
</head>
<body class="bg-gray-100 h-[100dvh] flex flex-col text-gray-800 overflow-hidden">

    <!-- 1. HEADER -->
    <header class="bg-[#008069] text-white p-4 shadow-md z-20 shrink-0">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <h1 class="font-bold text-lg flex items-center gap-2">
                <i class="ph ph-whatsapp-logo text-2xl"></i>
                Presupuestos
            </h1>
            <div class="flex gap-2">
                <!-- Bot贸n Archivo / Guardados -->
                <button onclick="toggleSavedModal()" class="p-2 rounded-full hover:bg-[#006653] transition relative" aria-label="Guardados">
                    <i class="ph ph-folder text-xl"></i>
                </button>
                <!-- Bot贸n Ayuda / Tutorial -->
                <button onclick="startTutorial()" class="p-2 rounded-full hover:bg-[#006653] transition" aria-label="Ayuda">
                    <i class="ph ph-question text-xl"></i>
                </button>
                <button onclick="toggleConfig()" class="p-2 rounded-full hover:bg-[#006653] transition" aria-label="Configuraci贸n">
                    <i class="ph ph-gear text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- Alerta de Datos Viejos -->
        <div id="staleDataAlert" class="hidden mt-2 bg-yellow-100 text-yellow-800 text-xs px-3 py-1 rounded border border-yellow-200 flex items-center gap-2">
            <i class="ph ph-warning"></i>
            <span>Datos desactualizados (+24h). Actualiza en configuraci贸n.</span>
        </div>
    </header>

    <!-- 2. SEARCH BAR (Sticky) -->
    <div class="bg-white p-3 shadow-sm z-10 shrink-0">
        <div class="max-w-7xl mx-auto relative">
            <i class="ph ph-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg"></i>
            <input type="text" id="searchInput" placeholder="Buscar producto o c贸digo..." 
                   class="w-full pl-10 pr-10 py-3 bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#008069] text-base"
                   autocomplete="off">
            <button id="clearSearch" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 p-1" onclick="clearInput()">
                <i class="ph ph-x-circle text-lg"></i>
            </button>
        </div>
    </div>

    <!-- 3. PRODUCT LIST AREA -->
    <main class="flex-1 overflow-y-auto no-scrollbar p-3 pb-40" id="mainContainer">
        <div id="productList" class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            <div class="col-span-full text-center text-gray-400 mt-10">
                <i class="ph ph-basket text-4xl mb-2"></i>
                <p>Cargando productos o configura la URL...</p>
            </div>
        </div>
        <div id="limitMessage" class="hidden text-center text-gray-400 text-sm mt-4 pb-4">
            Mostrando los primeros 100 resultados. Usa el buscador para filtrar.
        </div>
    </main>

    <!-- 4. FOOTER / CART BAR -->
    <div id="cartFooter" class="fixed bottom-0 left-0 w-full bg-white border-t shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] transform translate-y-full transition-transform duration-300 z-40 pb-[env(safe-area-inset-bottom)]">
        <div class="max-w-7xl mx-auto p-4 flex justify-between items-center">
            <div class="flex flex-col cursor-pointer select-none group" onclick="toggleCartView()">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500 font-medium group-hover:text-[#008069] transition-colors" id="itemCount">0 铆tems</span>
                    <div class="bg-gray-100 rounded-full p-0.5 group-hover:bg-green-50">
                        <i class="ph ph-caret-up text-gray-500 text-xs font-bold"></i>
                    </div>
                </div>
                <div class="flex items-baseline gap-1">
                    <span class="text-xl font-bold text-[#008069]" id="totalAmount">$0,00</span>
                    <span class="text-[10px] text-gray-400 font-medium uppercase tracking-wide">Ver detalle</span>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="shareToWhatsApp()" class="bg-white border-2 border-[#25D366] text-[#25D366] hover:bg-green-50 font-bold p-3 rounded-full shadow-md flex items-center justify-center active:scale-95 transition-transform" aria-label="Enviar a WhatsApp">
                    <i class="ph ph-whatsapp-logo text-2xl"></i>
                </button>
                <button onclick="copyBudget()" class="bg-[#25D366] hover:bg-[#20bd5a] text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center gap-2 active:scale-95 transition-transform">
                    <span>Copiar</span>
                    <i class="ph ph-copy text-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 6. CART MODAL VIEW -->
    <div id="cartModal" class="fixed inset-0 bg-gray-50 z-50 flex flex-col h-[100dvh] transform transition-transform duration-500 ease-spring translate-y-full shadow-2xl">
        <div class="bg-white p-4 shadow-sm flex justify-between items-center shrink-0 border-b z-10">
            <h2 class="font-bold text-lg flex items-center gap-2 text-gray-800">
                <i class="ph ph-shopping-cart text-[#008069] text-xl"></i>
                Resumen del Pedido
            </h2>
            <button onclick="toggleCartView()" class="p-2 rounded-full hover:bg-gray-100 text-gray-500 active:scale-95 transition-transform">
                <i class="ph ph-caret-down text-2xl"></i>
            </button>
        </div>
        
        <div id="cartListContainer" class="flex-1 overflow-y-auto p-4 pb-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 content-start">
            <!-- Se llena via JS -->
        </div>

        <div class="bg-white border-t p-4 shrink-0 pb-[env(safe-area-inset-bottom)] shadow-[0_-4px_15px_rgba(0,0,0,0.05)]">
            <div class="flex justify-between items-end mb-4 px-1">
                <span class="text-gray-500 font-medium">Total Final</span>
                <span class="text-3xl font-bold text-[#008069]" id="cartModalTotal">$0,00</span>
            </div>
            <!-- Grid de acciones con el bot贸n de Guardar a帽adido -->
            <div class="grid grid-cols-5 gap-3">
                 <button onclick="saveCurrentBudget()" class="col-span-1 bg-gray-100 text-gray-700 font-bold rounded-xl flex items-center justify-center active:bg-gray-200" title="Guardar Presupuesto">
                    <i class="ph ph-floppy-disk text-2xl"></i>
                 </button>
                 <button onclick="shareToWhatsApp()" class="col-span-2 bg-white border-2 border-[#25D366] text-[#25D366] font-bold py-3.5 rounded-xl shadow-sm flex items-center justify-center gap-2 active:bg-green-50 active:scale-[0.98] transition-transform">
                    <i class="ph ph-whatsapp-logo text-xl"></i> WhatsApp
                 </button>
                 <button onclick="copyBudget()" class="col-span-2 bg-[#25D366] text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-2 active:bg-[#1da851] active:scale-[0.98] transition-transform">
                    <i class="ph ph-copy text-xl"></i> Copiar
                 </button>
            </div>
        </div>
    </div>

    <!-- 8. SAVED BUDGETS MODAL -->
    <div id="savedModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full h-full md:w-11/12 md:max-w-4xl md:h-[90vh] md:rounded-xl shadow-2xl overflow-hidden flex flex-col transition-all">
            <div class="bg-[#008069] text-white p-4 flex justify-between items-center shrink-0">
                <h2 class="font-bold flex items-center gap-2">
                    <i class="ph ph-folder-open text-xl"></i> Presupuestos Guardados
                </h2>
                <button onclick="toggleSavedModal()" class="p-1"><i class="ph ph-x text-xl"></i></button>
            </div>
            
            <!-- Barra de b煤squeda y Filtro de Fecha -->
            <div class="p-3 bg-white border-b border-gray-100 shrink-0 flex gap-2">
                <div class="relative flex-1">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="savedSearchInput" placeholder="Buscar cliente..." 
                           class="w-full pl-9 pr-3 py-2 bg-gray-100 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-[#008069]"
                           oninput="applySavedFilters()">
                </div>
                <!-- Input de Fecha -->
                <input type="date" id="savedDateInput" class="bg-gray-100 rounded-lg text-sm px-2 focus:outline-none focus:ring-1 focus:ring-[#008069] text-gray-600 w-auto" onchange="applySavedFilters()">
            </div>

            <div id="savedListContainer" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                <!-- Se llena via JS -->
                <div class="text-center text-gray-400 mt-10">
                    <i class="ph ph-files text-4xl mb-2"></i>
                    <p>No tienes presupuestos guardados.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. CONFIG MODAL (Con Bot贸n de Instalar PWA) -->
    <!-- FIX: Z-Index aumentado a 60 para estar por encima de otros modales y asegurar clicabilidad -->
    <div id="configModal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-[#008069] text-white p-4 flex justify-between items-center shrink-0">
                <h2 class="font-bold">Configuraci贸n</h2>
                <button onclick="toggleConfig()" class="p-1"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                
                <div id="installContainer" class="hidden mb-4 p-3 bg-green-50 rounded-lg border border-green-200 shadow-sm">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">URL del CSV (Google Sheets)</label>
                    <input type="text" id="csvUrlInput" placeholder="https://docs.google.com/spreadsheets/..." 
                           class="w-full border p-3 rounded-lg text-sm focus:ring-2 focus:ring-[#008069] outline-none">
                    <p class="text-xs text-gray-500 mt-1">Archivo > Compartir > Publicar en la web > CSV</p>
                </div>

                <!-- GUIA VISUAL DE COLUMNAS -->
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-xs text-blue-800">
                    <p class="font-bold mb-1 flex items-center gap-1">
                        <i class="ph ph-info text-sm"></i> Estructura del CSV:
                    </p>
                    <ul class="list-none space-y-1 ml-1">
                        <li><b class="bg-blue-200 px-1 rounded text-[10px]">Col A</b> ID / C贸digo <span class="text-blue-600">(Visible en Tarjeta)</span></li>
                        <li><b class="bg-blue-200 px-1 rounded text-[10px]">Col B</b> Nombre <span class="text-blue-600">(Obligatorio)</span></li>
                        <li><b class="bg-blue-200 px-1 rounded text-[10px]">Col C</b> Precio <span class="text-blue-600">(Obligatorio)</span></li>
                        <li><b class="bg-blue-200 px-1 rounded text-[10px]">Col D</b> Presentaci贸n</li>
                        <li><b class="bg-blue-200 px-1 rounded text-[10px]">Col E</b> Fecha Act.</li>
                    </ul>
                </div>
                
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded text-sm">
                    <span class="text-gray-600">ltima actualizaci贸n:</span>
                    <span id="lastUpdatedDate" class="font-mono font-bold">Nunca</span>
                </div>

                <div class="pt-2 flex gap-3">
                    <button onclick="fetchData()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium active:bg-blue-700 flex justify-center items-center gap-2">
                        <i class="ph ph-arrows-clockwise"></i> Actualizar Datos
                    </button>
                </div>
                
                <div class="border-t pt-4 flex flex-col gap-2">
                     <!-- FIX: Onclick actualizado para nueva l贸gica de doble toque -->
                     <button id="btnClearData" onclick="clearData(event)" class="w-full text-red-500 text-sm py-2 hover:bg-red-50 rounded font-medium transition-colors select-none">
                        Borrar cach茅 y reiniciar
                    </button>
                    <span class="text-center text-[10px] text-gray-400">Versi贸n App: <span id="appVersionDisplay">Cargando...</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. TUTORIAL / ONBOARDING MODAL -->
    <div id="tutorialModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden relative flex flex-col min-h-[400px]">
            <button onclick="closeTutorial(true)" class="absolute top-3 right-3 p-2 text-gray-400 hover:text-gray-600 z-10">
                <i class="ph ph-x text-xl"></i>
            </button>

            <div id="tutorialSlides" class="flex-1 p-8 flex flex-col items-center justify-center text-center">
            </div>

            <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
                <div class="flex gap-1.5" id="tutorialDots">
                </div>
                <button id="tutorialNextBtn" onclick="nextTutorialStep()" class="bg-[#008069] text-white px-6 py-2 rounded-full font-bold text-sm shadow active:scale-95 transition-transform">
                    Siguiente
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg text-sm font-medium z-50 flex items-center gap-2">
        <i class="ph ph-check-circle text-green-400 text-lg"></i>
        <span id="toastMsg">Copiado al portapapeles</span>
    </div>

    <script>
        // ==========================================
        //  CONFIGURACIN FIJA
        const URL_FIJA_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS8v6EfTn5QfJPDmaCZRfFaAmkdopFrYPBh9N0s3ifH3_q257I_zgXxNz-GJUByuQbAgc0kfeXLZEJZ/pub?gid=1147648108&single=true&output=csv"; 
        const APP_VERSION = "v2.6 (SW Error Fix)";
        // ==========================================

        const normalize = (str) => {
            if (!str) return "";
            return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        };

        const state = {
            products: [],   // { id, code, name, price, presentation, searchString, lastUpdate }
            groups: [],     // { groupIndex, name, ids: [id1, id2], activeIndex, searchString }
            cart: {},       // { id: qty }
            saved: [],      // { id, name, date, total, text }
            config: {
                url: '',
                lastUpdated: 0
            }
        };

        // --- PWA INSTALLATION LOGIC ---
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallUI('android');
        });

        function showInstallUI(type) {
            const container = document.getElementById('installContainer');
            container.classList.remove('hidden');
            
            if (type === 'ios') {
                container.innerHTML = `
                    <p class="text-xs text-green-800 mb-2 font-bold flex items-center gap-1">
                        <i class="ph ph-apple-logo text-lg"></i> Instalaci贸n en iPhone/iPad
                    </p>
                    <div class="text-sm text-gray-700 bg-white p-3 rounded border border-green-100">
                        <ol class="list-decimal ml-4 space-y-1">
                            <li>Toca el bot贸n <b>Compartir</b> <i class="ph ph-share-network"></i> abajo.</li>
                            <li>Baja y selecciona <b>Agregar a Inicio</b> <i class="ph ph-plus-square"></i>.</li>
                        </ol>
                    </div>
                `;
            } else {
                container.innerHTML = `
                     <p class="text-xs text-green-700 mb-2 font-medium">Instala esta app para un acceso m谩s r谩pido</p>
                     <button id="installBtn" class="w-full bg-[#008069] text-white py-2 rounded-lg font-bold text-sm shadow flex justify-center items-center gap-2 active:bg-[#006653]">
                        <i class="ph ph-download-simple"></i> Instalar App
                     </button>
                `;
                
                document.getElementById('installBtn').onclick = async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            container.classList.add('hidden');
                        }
                        deferredPrompt = null;
                    }
                };
            }
        }

        // --- TUTORIAL LOGIC ---
        const tutorialSteps = [
            {
                icon: "ph-magnifying-glass",
                title: "B煤squeda Inteligente",
                text: "Encuentra productos por nombre, c贸digo o marca. <br><b>No importa el orden de las palabras</b>."
            },
            {
                icon: "ph-stack",
                title: "Productos Agrupados",
                text: "Si un producto tiene varias presentaciones (Unidad, Bulto), ver谩s botones para cambiar entre ellas en la misma tarjeta."
            },
            {
                icon: "ph-floppy-disk",
                title: "Guardar Historial",
                text: "Guarda tus presupuestos. Ahora puedes <b>filtrar por nombre y fecha</b> en la carpeta ."
            },
            {
                icon: "ph-gear",
                title: "Configuraci贸n",
                text: "Usa el 铆cono 锔 para actualizar precios desde tu <b>Google Sheet</b>. La app funciona sin internet una vez cargada."
            }
        ];

        let currentStep = 0;

        function startTutorial() {
            currentStep = 0;
            renderTutorialStep();
            document.getElementById('tutorialModal').classList.remove('hidden');
        }

        function closeTutorial(permanent = false) {
            document.getElementById('tutorialModal').classList.add('hidden');
            if (permanent) {
                localStorage.setItem('tutorial_seen', 'true');
            }
        }

        function nextTutorialStep() {
            if (currentStep < tutorialSteps.length - 1) {
                currentStep++;
                renderTutorialStep();
            } else {
                closeTutorial(true);
            }
        }

        function renderTutorialStep() {
            const slide = tutorialSteps[currentStep];
            const container = document.getElementById('tutorialSlides');
            const dotsContainer = document.getElementById('tutorialDots');
            const btn = document.getElementById('tutorialNextBtn');

            container.innerHTML = `
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6 text-[#008069]">
                    <i class="ph ${slide.icon} text-4xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-3">${slide.title}</h3>
                <p class="text-gray-600 leading-relaxed">${slide.text}</p>
            `;

            dotsContainer.innerHTML = tutorialSteps.map((_, idx) => `
                <div class="w-2.5 h-2.5 rounded-full dot ${idx === currentStep ? 'active' : 'bg-gray-300'}"></div>
            `).join('');

            btn.textContent = currentStep === tutorialSteps.length - 1 ? "隆Entendido!" : "Siguiente";
        }

        // --- INICIALIZACIN ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            setupSearch();
            setupConfigInput();
            renderList();
            checkStaleData();
            
            document.getElementById('appVersionDisplay').textContent = APP_VERSION;

            if (!localStorage.getItem('tutorial_seen')) {
                setTimeout(() => startTutorial(), 1000);
            }

            const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
            if (isIos && !isStandalone) showInstallUI('ios');

            if ('serviceWorker' in navigator) {
                try {
                    const swCode = "self.addEventListener('fetch', () => {}); self.addEventListener('install', () => self.skipWaiting());";
                    const blob = new Blob([swCode], {type: 'text/javascript'});
                    const swUrl = URL.createObjectURL(blob);
                    navigator.serviceWorker.register(swUrl).catch(() => {});
                } catch(e) {}
            }
        });

        function setupConfigInput() {
            const input = document.getElementById('csvUrlInput');
            const save = () => {
                state.config.url = input.value.trim();
                saveConfig();
            };
            input.addEventListener('input', save);
            input.addEventListener('change', save);
        }

        // --- GESTIN DE DATOS ---
        function loadState() {
            const storedConfig = localStorage.getItem('app_config');
            if (storedConfig) {
                try {
                    const parsed = JSON.parse(storedConfig);
                    state.config = { ...state.config, ...parsed };
                } catch (e) { console.error(e); }
            }

            if (!state.config.url && URL_FIJA_CSV) {
                state.config.url = URL_FIJA_CSV;
            }
            
            const storedProducts = localStorage.getItem('app_products');
            if (storedProducts) {
                try {
                    state.products = JSON.parse(storedProducts);
                    // Reconstruir grupos en memoria
                    buildGroups();
                } catch(e) {}
            }

            const storedSaved = localStorage.getItem('app_saved_budgets');
            if (storedSaved) {
                try {
                    state.saved = JSON.parse(storedSaved);
                } catch(e) {}
            }

            document.getElementById('csvUrlInput').value = state.config.url || '';
            updateLastUpdatedLabel();
        }

        function saveConfig() {
            localStorage.setItem('app_config', JSON.stringify(state.config));
        }

        function saveSavedBudgets() {
            localStorage.setItem('app_saved_budgets', JSON.stringify(state.saved));
        }

        function updateLastUpdatedLabel() {
            const dateSpan = document.getElementById('lastUpdatedDate');
            if (state.config.lastUpdated === 0) {
                dateSpan.textContent = "Nunca";
            } else {
                const date = new Date(state.config.lastUpdated);
                dateSpan.textContent = date.toLocaleString('es-AR');
            }
        }

        async function fetchData() {
            let url = document.getElementById('csvUrlInput').value.trim();
            if (!url && URL_FIJA_CSV) url = URL_FIJA_CSV;

            if (!url) return showToast("Ingresa una URL v谩lida");

            document.getElementById('csvUrlInput').value = url;
            state.config.url = url;
            saveConfig();

            const btn = document.querySelector('#configModal button i.ph-arrows-clockwise');
            btn.classList.add('animate-spin');

            try {
                const cacheBusterUrl = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
                const response = await fetch(cacheBusterUrl);
                
                if (!response.ok) throw new Error("Error de red");
                const text = await response.text();
                
                parseCSV(text);
                
                state.config.lastUpdated = Date.now();
                saveConfig();
                
                localStorage.setItem('app_products', JSON.stringify(state.products));
                
                updateLastUpdatedLabel();
                renderList();
                checkStaleData();
                toggleConfig(); 
                showToast(`Se cargaron ${state.products.length} productos`);

            } catch (error) {
                let msg = "Error al cargar el CSV: " + error.message;
                const isLocal = window.location.protocol === 'file:' || window.location.protocol === 'content:';
                if (isLocal && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                    msg = "锔 ERROR DE SEGURIDAD (CORS)\n\nEst谩s abriendo el archivo localmente. S煤belo a Netlify/GitHub para que funcione.";
                }
                alert(msg);
                console.error(error);
            } finally {
                btn.classList.remove('animate-spin');
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split(/\r\n|\n/);
            const products = [];
            
            lines.forEach((line, index) => {
                if (!line.trim()) return;

                const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(col => {
                    return col.trim().replace(/^"|"$/g, '').replace(/""/g, '"');
                });
                
                if (cols.length >= 3) {
                    const code = cols[0]; // ID / C贸digo
                    const name = cols[1]; 
                    const priceStr = cols[2];
                    let presentation = '';
                    if (cols.length >= 4) presentation = cols[3];

                    let lastUpdate = '';
                    if (cols.length >= 5) lastUpdate = cols[4];
                    
                    const price = parseLocaleNumber(priceStr);

                    if (name && !isNaN(price) && price > 0) {
                        const searchString = normalize(code + ' ' + name + ' ' + presentation);
                        products.push({
                            id: index,
                            code: code,
                            name: name,
                            price: price,
                            priceRaw: priceStr,
                            presentation: presentation,
                            lastUpdate: lastUpdate,
                            searchString: searchString
                        });
                    }
                }
            });

            state.products = products;
            buildGroups();
        }

        function buildGroups() {
            const groupsMap = new Map();
            state.products.forEach(p => {
                const key = normalize(p.name);
                if(!groupsMap.has(key)) {
                    groupsMap.set(key, {
                        name: p.name,
                        ids: [],
                        searchString: ''
                    });
                }
                const group = groupsMap.get(key);
                group.ids.push(p.id);
                group.searchString += ' ' + p.searchString;
            });
            // Convert map to array and assign groupIndex
            state.groups = Array.from(groupsMap.values()).map((g, i) => ({
                ...g, 
                groupIndex: i, 
                activeIndex: 0 
            }));
        }

        function parseLocaleNumber(stringNumber) {
            let clean = stringNumber.replace(/[$ "\s]/g, '');
            if (clean.indexOf('.') !== -1 && clean.indexOf(',') !== -1) {
                clean = clean.replace(/\./g, '').replace(',', '.');
            } else if (clean.indexOf(',') !== -1) {
                clean = clean.replace(',', '.');
            } else if (clean.indexOf('.') !== -1) {
                clean = clean.replace(/\./g, '');
            }
            return parseFloat(clean);
        }

        function checkStaleData() {
            const alert = document.getElementById('staleDataAlert');
            const oneDay = 24 * 60 * 60 * 1000;
            if (state.config.lastUpdated > 0 && (Date.now() - state.config.lastUpdated > oneDay)) {
                alert.classList.remove('hidden');
            } else {
                alert.classList.add('hidden');
            }
        }

        // --- RENDERIZADO OPTIMIZADO PARA GRUPOS ---
        function renderList(filterText = '') {
            const list = document.getElementById('productList');
            const limitMsg = document.getElementById('limitMessage');
            list.innerHTML = '';

            const cleanFilter = normalize(filterText).trim();
            let filteredGroups = state.groups;

            if (cleanFilter) {
                const terms = cleanFilter.split(/\s+/);
                filteredGroups = state.groups.filter(g => {
                    return terms.every(term => g.searchString.includes(term));
                });
            }

            if (filteredGroups.length === 0) {
                list.innerHTML = `<div class="col-span-full text-center text-gray-400 mt-10">No se encontraron productos</div>`;
                limitMsg.classList.add('hidden');
                return;
            }

            const MAX_ITEMS = 100;
            const itemsToShow = filteredGroups.slice(0, MAX_ITEMS);
            
            if (filteredGroups.length > MAX_ITEMS) {
                limitMsg.classList.remove('hidden');
            } else {
                limitMsg.classList.add('hidden');
            }

            const fragment = document.createDocumentFragment();

            itemsToShow.forEach(group => {
                // Get current active product in the group
                const activeId = group.ids[group.activeIndex];
                const p = state.products.find(prod => prod.id === activeId);
                
                if(!p) return;

                const qty = state.cart[p.id] || 0;
                const isSelected = qty > 0;
                
                const el = document.createElement('div');
                el.id = `group-card-${group.groupIndex}`;
                el.className = `p-3 rounded-xl shadow-sm border card-transition cursor-pointer select-none flex flex-col justify-between h-full ${isSelected ? 'bg-green-50 border-[#25D366] ring-1 ring-[#25D366]' : 'bg-white border-gray-200 hover:border-gray-300'}`;
                
                // Click on card adds/selects the ACTIVE variant
                el.onclick = (e) => handleCardClick(e, p.id);

                const formattedPrice = formatMoney(p.price);
                const presentationBadge = p.presentation 
                    ? `<span class="inline-block mt-1 bg-gray-100 text-gray-500 text-[10px] font-semibold px-2 py-0.5 rounded border border-gray-200 uppercase tracking-wide">${p.presentation}</span>` 
                    : '';
                
                const dateText = p.lastUpdate
                    ? `<span class="text-[10px] text-gray-400 mt-0.5 block">Act: ${p.lastUpdate}</span>`
                    : '';
                
                // C贸digo/ID Display
                const codeHtml = p.code ? `<span class="text-[10px] font-mono text-gray-400 mb-0.5 block tracking-wider">${p.code}</span>` : '';

                // Variant Toggle HTML
                let variantsHtml = '';
                if (group.ids.length > 1) {
                    variantsHtml = `<div class="flex gap-1 mb-2 overflow-x-auto no-scrollbar" onclick="event.stopPropagation()">`;
                    group.ids.forEach((vid, idx) => {
                        const vp = state.products.find(x => x.id === vid);
                        const isActive = idx === group.activeIndex;
                        const label = vp.presentation ? vp.presentation : (idx === 0 ? 'Opci贸n 1' : 'Opci贸n 2');
                        // Simplificaci贸n de etiquetas para casos comunes
                        const displayLabel = label.toLowerCase().includes('bulto') || label.toLowerCase().includes('pack') ? 'Bulto' : 'Unidad';
                        
                        variantsHtml += `
                            <div onclick="toggleVariant(${group.groupIndex}, ${idx})" 
                                 class="variant-pill ${isActive ? 'active' : 'inactive'}">
                                ${label}
                            </div>
                        `;
                    });
                    variantsHtml += `</div>`;
                }

                el.innerHTML = `
                    <div class="flex-1 w-full flex flex-col items-start">
                        ${codeHtml}
                        <h3 class="font-medium text-gray-800 text-sm leading-snug w-full line-clamp-2 ${isSelected ? 'text-[#008069] font-bold' : ''}">${p.name}</h3>
                        ${variantsHtml ? '' : presentationBadge} 
                        
                        ${variantsHtml}

                        <div class="mt-auto w-full">
                            <p class="text-[#008069] font-bold text-base leading-none">${formattedPrice}</p>
                            ${dateText}
                        </div>
                    </div>
                    
                    <div id="controls-${p.id}" class="${isSelected ? 'flex' : 'hidden'} items-center justify-between w-full mt-3 bg-white/50 rounded-lg p-1 gap-2" onclick="event.stopPropagation()">
                        <button class="w-8 h-8 flex-shrink-0 flex items-center justify-center bg-white border border-gray-200 shadow-sm rounded-lg text-gray-600 active:bg-gray-100" onclick="updateQty(${p.id}, -1, ${group.groupIndex})">
                            <i class="ph ph-minus font-bold text-xs"></i>
                        </button>
                        <span id="qty-${p.id}" class="flex-1 text-center font-bold text-base min-w-[20px]">${qty}</span>
                        <button class="w-8 h-8 flex-shrink-0 flex items-center justify-center bg-[#25D366] text-white shadow-sm rounded-lg active:bg-[#1da851]" onclick="updateQty(${p.id}, 1, ${group.groupIndex})">
                            <i class="ph ph-plus font-bold text-xs"></i>
                        </button>
                    </div>
                `;
                fragment.appendChild(el);
            });

            list.appendChild(fragment);
        }

        // --- FUNCIONES LOGICA UI ---
        
        function toggleVariant(groupIndex, newIndex) {
            state.groups[groupIndex].activeIndex = newIndex;
            // Re-renderizar solo la lista es lo m谩s seguro para mantener consistencia visual r谩pida
            // Podr铆amos optimizar re-renderizando solo esa carta, pero renderList es r谩pido
            // Para mantener el foco, idealmente buscamos el input, pero aqui es un click de boton
            renderList(document.getElementById('searchInput').value);
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(amount);
        }

        function handleCardClick(e, id) {
            if (!state.cart[id]) {
                // Necesitamos el groupIndex para pasar a updateQty si queremos refrescar solo la carta
                // Buscamos el producto para saber su grupo
                const p = state.products.find(x => x.id === id);
                const grp = state.groups.find(g => g.ids.includes(id));
                updateQty(id, 1, grp ? grp.groupIndex : null);
                
                const input = document.getElementById('searchInput');
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 50);
            }
        }

        function updateQty(id, change, groupIndex) {
            const current = state.cart[id] || 0;
            const newQty = current + change;

            if (newQty <= 0) {
                delete state.cart[id];
            } else {
                state.cart[id] = newQty;
            }

            // Actualizar vista. Si tenemos groupIndex, podemos intentar ser espec铆ficos,
            // pero dado que el cambio de cantidad puede afectar el estilo de la carta (borde verde/blanco)
            // y el DOM ID depende del grupo, lo m谩s simple es refrescar la lista si hay filtro,
            // o manipular el DOM directamente si es posible.
            // Para simplicidad y robustez con el nuevo sistema de grupos:
            renderList(document.getElementById('searchInput').value);

            const cartModal = document.getElementById('cartModal');
            if (!cartModal.classList.contains('translate-y-full')) {
                renderCartView();
            }

            updateFooter();
            
            const cartKeys = Object.keys(state.cart);
            if (cartKeys.length === 1 && newQty > 0) {
                autoCopySingleItem(id, newQty);
            }
        }

        // ... Resto de funciones (Toggle Cart, Render Cart, Copy, Share, etc.) IGUAL QUE ANTES ...

        function toggleCartView() {
            const modal = document.getElementById('cartModal');
            const isClosed = modal.classList.contains('translate-y-full');
            if (isClosed) { renderCartView(); modal.classList.remove('translate-y-full'); } 
            else { modal.classList.add('translate-y-full'); }
        }

        function renderCartView() {
            const container = document.getElementById('cartListContainer');
            container.innerHTML = '';
            const cartEntries = Object.entries(state.cart);
            if (cartEntries.length === 0) {
                container.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center h-64 text-gray-400"><i class="ph ph-shopping-cart text-6xl mb-4 text-gray-300"></i><p class="text-lg">Tu carrito est谩 vac铆o</p></div>`;
                return;
            }
            cartEntries.forEach(([id, qty]) => {
                const p = state.products.find(prod => prod.id == id);
                if (!p) return;
                const subtotal = p.price * qty;
                const presText = p.presentation ? `<span class="inline-block mt-1 bg-gray-100 text-gray-500 text-[10px] font-semibold px-2 py-0.5 rounded border border-gray-200 uppercase tracking-wide">${p.presentation}</span>` : '';
                const el = document.createElement('div');
                el.className = "p-3 rounded-xl shadow-sm border border-gray-200 bg-white flex flex-col justify-between h-full";
                el.innerHTML = `
                    <div class="flex-1 w-full flex flex-col items-start">
                        <h4 class="font-medium text-gray-800 text-sm leading-snug w-full line-clamp-2">${p.name}</h4>
                        ${presText}
                        <div class="mt-2 w-full">
                            <p class="text-[#008069] font-bold text-base">${formatMoney(p.price)}</p>
                            <p class="text-xs text-gray-400 mt-0.5">Total: ${formatMoney(subtotal)}</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between w-full mt-3 bg-gray-50 rounded-lg p-1 gap-2">
                        <button class="w-8 h-8 flex-shrink-0 flex items-center justify-center bg-white border border-gray-200 shadow-sm rounded-lg text-gray-600 active:bg-gray-100" onclick="updateQty(${p.id}, -1)">
                            <i class="ph ${qty === 1 ? 'ph-trash text-red-500' : 'ph-minus'} font-bold text-xs"></i>
                        </button>
                        <span class="flex-1 text-center font-bold text-base min-w-[20px]">${qty}</span>
                        <button class="w-8 h-8 flex-shrink-0 flex items-center justify-center bg-[#25D366] text-white shadow-sm rounded-lg active:bg-[#1da851]" onclick="updateQty(${p.id}, 1)">
                            <i class="ph ph-plus font-bold text-xs"></i>
                        </button>
                    </div>`;
                container.appendChild(el);
            });
        }

        function clearInput() {
            const input = document.getElementById('searchInput');
            input.value = '';
            input.focus();
            renderList();
            document.getElementById('clearSearch').classList.add('hidden');
        }

        function setupSearch() {
            const input = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearSearch');
            let timeout = null;
            input.addEventListener('input', (e) => {
                const val = e.target.value;
                if (val) clearBtn.classList.remove('hidden'); else clearBtn.classList.add('hidden');
                clearTimeout(timeout);
                timeout = setTimeout(() => { renderList(val); }, 50);
            });
        }

        function updateFooter() {
            const footer = document.getElementById('cartFooter');
            const countEl = document.getElementById('itemCount');
            const totalEl = document.getElementById('totalAmount');
            const cartTotalEl = document.getElementById('cartModalTotal');
            const cartEntries = Object.entries(state.cart);
            if (cartEntries.length === 0) { footer.classList.add('translate-y-full'); return; }
            footer.classList.remove('translate-y-full');
            let totalItems = 0; let totalMoney = 0;
            cartEntries.forEach(([id, qty]) => {
                const product = state.products.find(p => p.id == id);
                if (product) { totalItems += qty; totalMoney += (product.price * qty); }
            });
            const textCount = `${totalItems} ${totalItems === 1 ? '铆tem' : '铆tems'}`;
            const textMoney = formatMoney(totalMoney);
            countEl.textContent = textCount;
            totalEl.textContent = textMoney;
            countEl.textContent = textCount;
            totalEl.textContent = textMoney;
            if (cartTotalEl) cartTotalEl.textContent = textMoney;
        }

        function autoCopySingleItem(id, qty) {
            const product = state.products.find(p => p.id == id);
            if (!product) return;
            const total = product.price * qty;
            const presText = product.presentation ? ` (${product.presentation})` : '';
            const text = `${qty} x ${product.name}${presText}: ${formatMoney(total)}`;
            copyTextToClipboard(text, "Copiado: " + text);
        }

        function generateBudgetText() {
            let text = "*Presupuesto:*\n";
            let grandTotal = 0;
            Object.entries(state.cart).forEach(([id, qty]) => {
                const product = state.products.find(p => p.id == id);
                if (product) {
                    const subtotal = product.price * qty;
                    grandTotal += subtotal;
                    const presText = product.presentation ? ` (${product.presentation})` : '';
                    text += `锔 ${qty} x ${product.name}${presText}: ${formatMoney(subtotal)}\n`;
                }
            });
            text += `\n*TOTAL: ${formatMoney(grandTotal)}*`;
            return text;
        }

        function copyBudget() {
            const text = generateBudgetText();
            copyTextToClipboard(text, "Presupuesto copiado a WhatsApp");
        }

        function shareToWhatsApp() {
            const text = generateBudgetText();
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function toggleSavedModal() {
            const modal = document.getElementById('savedModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) { 
                // Reset search when opening
                const input = document.getElementById('savedSearchInput');
                if(input) input.value = '';
                const dateInput = document.getElementById('savedDateInput');
                if(dateInput) dateInput.value = '';
                
                renderSavedBudgets(); 
            }
        }

        function saveCurrentBudget() {
            if (Object.keys(state.cart).length === 0) { return showToast("El carrito est谩 vac铆o"); }
            const clientName = prompt("Ingrese referencia o nombre del cliente:");
            if (!clientName) return;
            let total = 0;
            Object.entries(state.cart).forEach(([id, qty]) => {
                const p = state.products.find(x => x.id == id);
                if(p) total += (p.price * qty);
            });
            const text = generateBudgetText();
            // Guardamos el ID como timestamp, que usaremos para filtrar fecha
            const newBudget = { id: Date.now(), name: clientName, date: new Date().toLocaleString(), total: total, text: text };
            state.saved.unshift(newBudget);
            saveSavedBudgets();
            showToast("Presupuesto guardado");
        }

        function toggleBudgetDetail(id) {
            const detail = document.getElementById(`details-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            if (detail.classList.contains('hidden')) { detail.classList.remove('hidden'); icon.classList.add('rotate-180'); } 
            else { detail.classList.add('hidden'); icon.classList.remove('rotate-180'); }
        }

        function applySavedFilters() {
            const name = document.getElementById('savedSearchInput').value;
            const date = document.getElementById('savedDateInput').value;
            renderSavedBudgets(name, date);
        }

        function renderSavedBudgets(nameFilter = '', dateFilter = '') {
            const container = document.getElementById('savedListContainer');
            container.innerHTML = '';
            
            let filtered = state.saved;
            const term = normalize(nameFilter);

            filtered = state.saved.filter(b => {
                // Name Filter
                const matchesName = !term || normalize(b.name).includes(term) || b.date.includes(nameFilter);
                
                // Date Filter
                let matchesDate = true;
                if (dateFilter) {
                    const d = new Date(b.id);
                    // Local YYYY-MM-DD building manually to ensure local match
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const budgetIso = `${year}-${month}-${day}`;
                    matchesDate = (budgetIso === dateFilter);
                }
                
                return matchesName && matchesDate;
            });

            if (filtered.length === 0) {
                const msg = (nameFilter || dateFilter) ? "No se encontraron coincidencias." : "No tienes presupuestos guardados.";
                container.innerHTML = `<div class="text-center text-gray-400 mt-10"><i class="ph ph-files text-4xl mb-2"></i><p>${msg}</p></div>`;
                return;
            }

            filtered.forEach(budget => {
                const el = document.createElement('div');
                el.className = "bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden mb-3";
                const displayName = budget.name || "Sin nombre";
                el.innerHTML = `
                    <div onclick="toggleBudgetDetail(${budget.id})" class="p-3 flex justify-between items-center cursor-pointer bg-gray-50/50 hover:bg-gray-100 transition select-none">
                        <div><h4 class="font-bold text-gray-800 text-sm">${displayName}</h4><span class="text-[10px] text-gray-500 font-medium">${budget.date}</span></div>
                        <div class="flex items-center gap-3"><span class="font-bold text-[#008069] text-sm">${formatMoney(budget.total)}</span><i id="icon-${budget.id}" class="ph ph-caret-down text-gray-400 transition-transform duration-300 text-lg"></i></div>
                    </div>
                    <div id="details-${budget.id}" class="hidden border-t border-gray-100 bg-white">
                        <div class="p-3 text-xs text-gray-600 font-mono whitespace-pre-wrap bg-gray-50 m-2 rounded border border-gray-100 leading-relaxed">${budget.text}</div>
                        <div class="flex gap-2 p-2 justify-end bg-white border-t border-gray-50">
                            <button onclick="deleteSavedBudget(${budget.id})" class="p-2 text-red-500 bg-red-50 rounded hover:bg-red-100 transition"><i class="ph ph-trash text-lg"></i></button>
                             <button onclick="shareSavedText('${encodeURIComponent(budget.text)}')" class="px-3 py-2 text-[#25D366] bg-green-50 rounded hover:bg-green-100 flex gap-1 items-center font-bold text-xs transition"><i class="ph ph-whatsapp-logo text-lg"></i> WhatsApp</button>
                            <button onclick="copySavedText('${encodeURIComponent(budget.text)}')" class="px-3 py-2 text-gray-600 bg-gray-100 rounded hover:bg-gray-200 flex gap-1 items-center font-bold text-xs transition"><i class="ph ph-copy text-lg"></i> Copiar</button>
                        </div>
                    </div>`;
                container.appendChild(el);
            });
        }

        function deleteSavedBudget(id) {
            if(confirm("驴Eliminar este presupuesto?")) {
                state.saved = state.saved.filter(b => b.id !== id);
                saveSavedBudgets();
                // Re-apply filters
                applySavedFilters();
            }
        }

        window.shareSavedText = (encodedText) => { const text = decodeURIComponent(encodedText); window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank'); };
        window.copySavedText = (encodedText) => { const text = decodeURIComponent(encodedText); copyTextToClipboard(text, "Presupuesto copiado"); };

        function copyTextToClipboard(text, successMsg) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "0";
            document.body.appendChild(textArea); textArea.focus(); textArea.select();
            try { if (document.execCommand('copy')) showToast(successMsg); else showToast("No se pudo copiar autom谩ticamente"); } 
            catch (err) { console.error('Error', err); showToast("Error al intentar copiar"); }
            document.body.removeChild(textArea);
        }

        function toggleConfig() { document.getElementById('configModal').classList.toggle('hidden'); }
        
        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            toast.classList.add('show');
            if (window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 2500);
        }

        // --- NUEVA LGICA DE BORRADO DE DOBLE TOQUE (SIN CONFIRM) ---
        let clearStep = 0;
        
        function clearData(e) {
            if(e) e.preventDefault(); // Detener propagaci贸n
            
            const btn = document.getElementById('btnClearData');
            
            if (clearStep === 0) {
                // Paso 1: Pedir confirmaci贸n visual
                btn.textContent = "锔 驴Seguro? Toca de nuevo para borrar";
                btn.classList.remove('text-red-500', 'hover:bg-red-50');
                btn.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700');
                clearStep = 1;
                
                // Resetear si no confirma en 3 segundos
                setTimeout(() => {
                    if(clearStep === 1) {
                        resetClearButton();
                    }
                }, 3000);
                return;
            }

            // Paso 2: Ejecutar
            if (clearStep === 1) {
                performClear();
            }
        }

        function resetClearButton() {
            clearStep = 0;
            const btn = document.getElementById('btnClearData');
            if(btn) {
                btn.textContent = "Borrar cach茅 y reiniciar";
                btn.className = "w-full text-red-500 text-sm py-2 hover:bg-red-50 rounded font-medium transition-colors select-none";
            }
        }

        async function performClear() {
            const btn = document.getElementById('btnClearData');
            if(btn) {
                btn.textContent = "Borrando...";
                btn.disabled = true;
            }

            try {
                // 1. Borrar Storage (Prioridad 1)
                localStorage.clear(); 
                sessionStorage.clear(); // Por si acaso
                
                // 2. Intentar desregistrar SW (Prioridad 2 - Best effort)
                if ('serviceWorker' in navigator) {
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for(let registration of registrations) {
                            await registration.unregister();
                        }
                    } catch(swError) { 
                        // Silenciosamente ignorar errores de SW en entornos restringidos
                        console.warn("No se pudo limpiar el Service Worker (posible entorno restringido):", swError.message); 
                    }
                }
            } catch (e) {
                console.error("Error general al borrar:", e);
            }

            // 3. Feedback y Recarga
            showToast("Datos borrados. Reiniciando...");
            
            setTimeout(() => {
                window.location.reload(); 
            }, 1000);
        }
    </script>
</body>
</html>
